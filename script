-- data analytics --

use DataWarehouseAnalytics;

select  * from gold.fact_sales;

-- cumulative analysis--
-- calculate the total_sales of a month and running total for month -- 
-- default frame is between unbounded preceding & current row -- 
select order_date,
total_sales,
SUM(total_sales) OVER(ORDER BY order_date) as running_total_sales
FROM
(
SELECT
DATETRUNC(MONTH,order_date) as order_date,
SUM(sales_amount) as total_sales
FROM gold.fact_sales
WHERE order_date is not null
GROUP BY DATETRUNC(MONTH,order_date)
)t

-- partition by year in windows function both the total_sales & running total will be same-- 

select order_date,
total_sales,
SUM(total_sales) OVER(PARTITION BY order_date ORDER BY order_date) as running_total_sales
FROM
(
SELECT
DATETRUNC(MONTH,order_date) as order_date,
SUM(sales_amount) as total_sales
FROM gold.fact_sales
WHERE order_date is not null
GROUP BY DATETRUNC(MONTH,order_date)
)t

-- analysis by year --
-- cumulative analysis--
-- calculate the total_sales of a month and running total for month -- 
-- default frame is between unbounded preceding & current row -- 

select order_date,
total_sales,
SUM(total_sales) OVER(ORDER BY order_date) as running_total_sales,
AVG(avg_price) OVER(ORDER BY order_date) as moving_avg_price
FROM
(
SELECT
DATETRUNC(YEAR,order_date) as order_date,
SUM(sales_amount) as total_sales,
AVG(price) as avg_price
FROM gold.fact_sales
WHERE order_date is not null
GROUP BY DATETRUNC(YEAR,order_date)
)t

-- performance analysis -- comparing the current value to the target value --  current measure - target measure

-- current year sales - previous year sales -- YOY analysis

/* analyse the yearly performance of products by comparing their sales 
to both the average sales performance of the product and the previous year's sales */

SELECT * FROM gold.fact_sales;
SELECT * FROM gold.dim_products;

WITH yearly_product_sales as 
(
SELECT 
YEAR(f.order_date) as order_year,
p.product_name,
SUM(f.sales_amount) as current_sales
FROM gold.fact_sales f
LEFT JOIN gold.dim_products p
on f.product_key = p.product_key
where f.order_date is not null
group by YEAR(f.order_date),p.product_name
)
select order_year,
	product_name,
	current_sales,
	AVG(current_sales)OVER(PARTITION BY product_name) as average_sales,
	current_sales - AVG(current_sales)OVER(PARTITION BY product_name) as diff_avg,
	CASE
	WHEN current_sales - AVG(current_sales)OVER(PARTITION BY product_name) > 0 THEN 'Above Avg'
	WHEN current_sales - AVG(current_sales)OVER(PARTITION BY product_name) < 0 THEN 'Below Avg'
	ELSE 'Avg'
	END as avg_change,
	-- year over year Analysis -- 
	LAG(current_sales) OVER(PARTITION BY product_name ORDER BY order_year) as previous_sales,
	current_sales - LAG(current_sales) OVER(PARTITION BY product_name ORDER BY order_year) as diff_sales,
	CASE
	WHEN current_sales - LAG(current_sales) OVER(PARTITION BY product_name ORDER BY order_year) > 0 THEN 'Increased'
	WHEN current_sales - LAG(current_sales) OVER(PARTITION BY product_name ORDER BY order_year) < 0 THEN 'Decreased'
	ELSE 'No Change'
	END as py_change
FROM yearly_product_sales
order by product_name,order_year;


-- Part to whole analysis --	proportional analysis -- 
-- understand which part is giving higher sales -- 
-- measure / Total(measure) * 100 by dimension





	



